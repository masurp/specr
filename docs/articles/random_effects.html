<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Incorporating multilevel models • specr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Incorporating multilevel models">
<meta property="og:description" content="specr">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    

    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">specr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">1.0.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../articles/specr.html">Getting started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li class="dropdown-header">Basics</li>
    <li>
      <a href="../articles/different-specifications.html">Setting up different types of specifications</a>
    </li>
    <li>
      <a href="../articles/custom-plot.html">Visualizing specification curve analyses</a>
    </li>
    <li>
      <a href="../articles/invest-spec.html">Investigating specific specifications</a>
    </li>
    <li>
      <a href="../articles/parallelization.html">Parallelization</a>
    </li>
    <li class="divider">
    </li>
<li class="dropdown-header">Incorporating specific models</li>
    <li>
      <a href="../articles/measurement_models.html">Structural equation models</a>
    </li>
    <li>
      <a href="../articles/random_effects.html">Multilevel models</a>
    </li>
    <li>
      <a href="../articles/bayesian-models.html">Bayesian Modeling</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/masurp/specr" class="external-link">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Incorporating multilevel models</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/masurp/specr/blob/HEAD/vignettes/random_effects.Rmd" class="external-link"><code>vignettes/random_effects.Rmd</code></a></small>
      <div class="hidden name"><code>random_effects.Rmd</code></div>

    </div>

    
    
<p>Many data are hierarchical and we want to acknowledge the nested
structure in our models. Specr can easily estimate such multilevel
models. We again have to write a customized function that we can pass
first to <code><a href="../reference/setup.html">setup()</a></code> and the <code><a href="../reference/specr.html">specr()</a></code> will do the
rest.</p>
<p>For this example, we will us the <code>gapminder</code> data set that
is included in the <code>gapminder</code>-package. We quickly recode
some variable to get more interpretable estimates.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Load packages</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyverse.tidyverse.org" class="external-link">tidyverse</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://masurp.github.io/specr/" class="external-link">specr</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/jennybc/gapminder" class="external-link">gapminder</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/" class="external-link">lme4</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/DavisVaughan/furrr" class="external-link">furrr</a></span><span class="op">)</span>  <span class="co"># For parallelization!</span></span>
<span></span>
<span><span class="co"># Recode some variables</span></span>
<span><span class="va">gapminder</span> <span class="op">&lt;-</span> <span class="va">gapminder</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>gdpPercap_log <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">gdpPercap</span><span class="op">)</span>,</span>
<span>         pop <span class="op">=</span> <span class="va">pop</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check data</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">gapminder</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 7</span></span></span>
<span><span class="co">#&gt;   country     continent  year lifeExp    pop gdpPercap gdpPercap_log</span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>       <span style="color: #949494; font-style: italic;">&lt;fct&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;int&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;dbl&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> Afghanistan Asia       <span style="text-decoration: underline;">1</span>952    28.8  <span style="text-decoration: underline;">8</span>425.      779.          6.66</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> Afghanistan Asia       <span style="text-decoration: underline;">1</span>957    30.3  <span style="text-decoration: underline;">9</span>241.      821.          6.71</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> Afghanistan Asia       <span style="text-decoration: underline;">1</span>962    32.0 <span style="text-decoration: underline;">10</span>267.      853.          6.75</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> Afghanistan Asia       <span style="text-decoration: underline;">1</span>967    34.0 <span style="text-decoration: underline;">11</span>538.      836.          6.73</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> Afghanistan Asia       <span style="text-decoration: underline;">1</span>972    36.1 <span style="text-decoration: underline;">13</span>079.      740.          6.61</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> Afghanistan Asia       <span style="text-decoration: underline;">1</span>977    38.4 <span style="text-decoration: underline;">14</span>880.      786.          6.67</span></span></code></pre></div>
<div class="section level2">
<h2 id="simply-adding-a-random-effect-structure">Simply adding a random effect structure<a class="anchor" aria-label="anchor" href="#simply-adding-a-random-effect-structure"></a>
</h2>
<p>For this example, we use the package <code>lme4</code> and more
specifically the function <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer()</a></code> to estimate the multilevel
model (more complex models such as poisson or negative binomial
multilevel models can likewise be estimated).</p>
<p>Based on the data set, we want to estimate the relationship between
<code>gdpPercap</code> (GDP per capita) and <code>lifeExp</code> (life
expectancy). Both variables are nested within both countries and years.
We can simply add a respective random effect structure via the argument
<code>add_to_formula</code>. This way, this will be automatically
included in the formula of all specifications. Because
<code>broom</code> doesn’t provide a <code>tidy</code> function for
<code>merMod</code>-objects resulting from <code><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lme4::lmer()</a></code>, we
need to add a new extraction function like so
<code>fun1 = new_function</code>. Luckily, we can use the
<code>broom.mixed</code> package, which agian provides a tidy function
for such objects.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">specs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/setup.html">setup</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>                y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lifeExp"</span><span class="op">)</span>,</span>
<span>                x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gdpPercap_log"</span><span class="op">)</span>, </span>
<span>                model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lmer"</span><span class="op">)</span>,</span>
<span>                controls <span class="op">=</span> <span class="st">"pop"</span>,</span>
<span>                fun1 <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu">broom.mixed</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">x</span>, conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                add_to_formula <span class="op">=</span> <span class="st">"(1|country) + (1|year)"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check formula</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">specs</span><span class="op">)</span></span>
<span><span class="co">#&gt; Setup for the Specification Curve Analysis</span></span>
<span><span class="co">#&gt; -------------------------------------------</span></span>
<span><span class="co">#&gt; Class:                      specr.setup -- version: 1.0.0 </span></span>
<span><span class="co">#&gt; Number of specifications:   2 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Specifications:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Independent variable:     gdpPercap_log </span></span>
<span><span class="co">#&gt;   Dependent variable:       lifeExp </span></span>
<span><span class="co">#&gt;   Models:                   lmer </span></span>
<span><span class="co">#&gt;   Covariates:               no covariates, pop </span></span>
<span><span class="co">#&gt;   Subsets analyses:         all </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Function used to extract parameters:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   function(x) broom.mixed::tidy(x, conf.int = TRUE)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Head of specifications table (first 6 rows):</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 6</span></span></span>
<span><span class="co">#&gt;   x             y       model controls      subsets formula                     </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;glue&gt;</span>                      </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> gdpPercap_log lifeExp lmer  no covariates all     lifeExp ~ gdpPercap_log + 1…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> gdpPercap_log lifeExp lmer  pop           all     lifeExp ~ gdpPercap_log + p…</span></span>
<span></span>
<span><span class="co"># Run analysis and inspect results</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/specr.html">specr</a></span><span class="op">(</span><span class="va">specs</span><span class="op">)</span></span>
<span><span class="co">#&gt; Warning: Some predictor variables are on very different scales: consider</span></span>
<span><span class="co">#&gt; rescaling</span></span>
<span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 2 × 22</span></span></span>
<span><span class="co">#&gt;   x       y     model controls subsets formula model_function effect group term </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>    <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;glue&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;list&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>  <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span> <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span></span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> gdpPer… life… lmer  no cova… all     lifeEx… <span style="color: #949494;">&lt;fn&gt;</span>           fixed  <span style="color: #BB0000;">NA</span>    gdpP…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> gdpPer… life… lmer  pop      all     lifeEx… <span style="color: #949494;">&lt;fn&gt;</span>           fixed  <span style="color: #BB0000;">NA</span>    gdpP…</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># … with 12 more variables: estimate &lt;dbl&gt;, std.error &lt;dbl&gt;, statistic &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   conf.low &lt;dbl&gt;, conf.high &lt;dbl&gt;, fit_nobs &lt;int&gt;, fit_sigma &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   fit_logLik &lt;dbl&gt;, fit_AIC &lt;dbl&gt;, fit_BIC &lt;dbl&gt;, fit_REMLcrit &lt;dbl&gt;,</span></span></span>
<span><span class="co">#&gt; <span style="color: #949494;">#   fit_df.residual &lt;int&gt;</span></span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="defining-customatized-multilevel-functions">Defining customatized multilevel functions<a class="anchor" aria-label="anchor" href="#defining-customatized-multilevel-functions"></a>
</h2>
<p>Sometimes, we may not want to add one random effect structure to all
models and instead explore more specific random structure (and even
several different random effect structures). In this case, we create
several customized lmer-functions that account for different nesting
structures.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Random intercept model (only country as grouping variable)</span></span>
<span><span class="va">lmer_ri_1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span>,<span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/" class="external-link">lme4</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed" class="external-link">broom.mixed</a></span><span class="op">)</span></span>
<span>  <span class="va">formula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">formula</span>, <span class="st">"+ (1|country)"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Including random slopes (only country as grouping variable)</span></span>
<span><span class="va">lmer_rs_1</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span>,<span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/" class="external-link">lme4</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed" class="external-link">broom.mixed</a></span><span class="op">)</span></span>
<span>  <span class="va">slopevars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">formula</span>, <span class="st">" ~ "</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">formula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">formula</span>, <span class="st">"+ (1 + "</span>, <span class="va">slopevars</span>, <span class="st">"|country)"</span> <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Random intercept model (lifeExp is nested in both countries and years)</span></span>
<span><span class="va">lmer_ri_2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span>,<span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/" class="external-link">lme4</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed" class="external-link">broom.mixed</a></span><span class="op">)</span></span>
<span>  <span class="va">formula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">formula</span>, <span class="st">"+ (1|country) + (1|year)"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># Including random slopes (intercept and slopes are nested in both countries and years)</span></span>
<span><span class="va">lmer_rs_2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span>,<span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/lme4/lme4/" class="external-link">lme4</a></span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">require</a></span><span class="op">(</span><span class="va"><a href="https://github.com/bbolker/broom.mixed" class="external-link">broom.mixed</a></span><span class="op">)</span></span>
<span>  <span class="va">slopevars</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">formula</span>, <span class="st">" ~ "</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">formula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">formula</span>, <span class="st">"+ (1 + "</span>, <span class="va">slopevars</span>, <span class="st">"|country) + ("</span>, <span class="va">slopevars</span>, <span class="st">"|year)"</span> <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html" class="external-link">lmer</a></span><span class="op">(</span><span class="va">formula</span>, <span class="va">data</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level3">
<h3 id="setting-up-specifications">Setting up specifications<a class="anchor" aria-label="anchor" href="#setting-up-specifications"></a>
</h3>
<p>We can now use these function to estimate these models. In this
example, we investigate the influence of different nesting structures on
the fixed effect between GDP per capita and life expectancy.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Setup specifications with customized functions</span></span>
<span><span class="va">specs</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/setup.html">setup</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">gapminder</span>,</span>
<span>                y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lifeExp"</span><span class="op">)</span>,</span>
<span>                x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gdpPercap_log"</span><span class="op">)</span>, </span>
<span>                model <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lmer_ri_1"</span>, <span class="st">"lmer_ri_2"</span>, </span>
<span>                          <span class="st">"lmer_rs_1"</span>, <span class="st">"lmer_rs_2"</span><span class="op">)</span>,</span>
<span>               controls <span class="op">=</span> <span class="st">"pop"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Check specifications</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">specs</span><span class="op">)</span></span>
<span><span class="co">#&gt; Setup for the Specification Curve Analysis</span></span>
<span><span class="co">#&gt; -------------------------------------------</span></span>
<span><span class="co">#&gt; Class:                      specr.setup -- version: 1.0.0 </span></span>
<span><span class="co">#&gt; Number of specifications:   8 </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Specifications:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   Independent variable:     gdpPercap_log </span></span>
<span><span class="co">#&gt;   Dependent variable:       lifeExp </span></span>
<span><span class="co">#&gt;   Models:                   lmer_ri_1, lmer_ri_2, lmer_rs_1, lmer_rs_2 </span></span>
<span><span class="co">#&gt;   Covariates:               no covariates, pop </span></span>
<span><span class="co">#&gt;   Subsets analyses:         all </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Function used to extract parameters:</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;   function (x) </span></span>
<span><span class="co">#&gt; broom::tidy(x, conf.int = TRUE)</span></span>
<span><span class="co">#&gt; &lt;environment: 0x7fd618c393d8&gt;</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Head of specifications table (first 6 rows):</span></span>
<span><span class="co">#&gt; <span style="color: #949494;"># A tibble: 6 × 6</span></span></span>
<span><span class="co">#&gt;   x             y       model     controls      subsets formula                 </span></span>
<span><span class="co">#&gt;   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>     <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>         <span style="color: #949494; font-style: italic;">&lt;chr&gt;</span>   <span style="color: #949494; font-style: italic;">&lt;glue&gt;</span>                  </span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">1</span> gdpPercap_log lifeExp lmer_ri_1 no covariates all     lifeExp ~ gdpPercap_log…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">2</span> gdpPercap_log lifeExp lmer_ri_1 pop           all     lifeExp ~ gdpPercap_log…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">3</span> gdpPercap_log lifeExp lmer_ri_2 no covariates all     lifeExp ~ gdpPercap_log…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">4</span> gdpPercap_log lifeExp lmer_ri_2 pop           all     lifeExp ~ gdpPercap_log…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">5</span> gdpPercap_log lifeExp lmer_rs_1 no covariates all     lifeExp ~ gdpPercap_log…</span></span>
<span><span class="co">#&gt; <span style="color: #BCBCBC;">6</span> gdpPercap_log lifeExp lmer_rs_1 pop           all     lifeExp ~ gdpPercap_log…</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="fit-the-models">Fit the models<a class="anchor" aria-label="anchor" href="#fit-the-models"></a>
</h3>
<p>Now, we can simply fit the models with <code><a href="../reference/specr.html">specr()</a></code> as we are
used to. Although not really necessary here, I going to use
parallelization to exemplify how we can pass the created function to the
workers using <code>furrr_options</code>. We need to pass both new
functions as a list of “globals” and the packages that are additionally
required.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Create furrr_options and pass globals</span></span>
<span><span class="va">opts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://furrr.futureverse.org/reference/furrr_options.html" class="external-link">furrr_options</a></span><span class="op">(</span></span>
<span>  globals <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>lmer_ri_1 <span class="op">=</span> <span class="va">lmer_ri_1</span>, lmer_ri_2 <span class="op">=</span> <span class="va">lmer_ri_2</span>, </span>
<span>                 lmer_rs_1 <span class="op">=</span> <span class="va">lmer_rs_1</span>, lmer_rs_2 <span class="op">=</span> <span class="va">lmer_rs_2</span><span class="op">)</span>,</span>
<span>  packages <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lme4"</span>, <span class="st">"broom.mixed"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Specify future plan</span></span>
<span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">multisession</span>, workers <span class="op">=</span> <span class="fl">4</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Run analysis in parallel and plot results</span></span>
<span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/specr.html">specr</a></span><span class="op">(</span><span class="va">specs</span>, .options <span class="op">=</span> <span class="va">opts</span><span class="op">)</span>  <span class="co"># pass `furrr_options` here</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">results</span><span class="op">)</span></span></code></pre></div>
<p><img src="random_effects_files/figure-html/unnamed-chunk-5-1.png" width="100%"></p>
<p>At the end of our analysis, it makes sense to explicitly close
multisession workers by switching the plan back to sequential.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://future.futureverse.org/reference/plan.html" class="external-link">plan</a></span><span class="op">(</span><span class="va">sequential</span><span class="op">)</span></span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p></p>
<p>Developed by Philipp K. Masur, Michael Scharkow.</p>
</div>

<div class="pkgdown">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.6.</p>
</div>

      </footer>
</div>

  


  

  </body>
</html>
